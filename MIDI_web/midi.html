<!DOCTYPE html>
<meta charset="utf-8"> 
<html>
<head></head>

<style>
*{
    margin:0;
    padding:0;
}
</style>

<textarea id="sheet_music"></textarea>
<button id="p">播放</button>
<button id="r">隨機</button>
<button id="dis">顯示譜</button>
<input id="note_number" value="音符數量"></input>
<button id="save_file">存檔</button>

<script src="jquery-3.3.1.js"></script>
<script>
//https://stackoverflow.com/questions/7686197/how-can-i-avoid-autorepeated-keydown-events-in-javascript
//var keyAllowed = {};

var audio_element = [];
var sharp_music = "cdfga";
var music_order=[];
var music_file_name = [];
var str;
var temp_chord=[];
var chord=[];
var index=0;
var time_value = [];

for(var i=3;i<=16;i++)
{
 time_value.push(125*i);
}

music_order.push("1");
music_order.push("c");
music_order.push("2");
music_order.push("d");
music_order.push("3");
music_order.push("4");
music_order.push("f");
music_order.push("5");
music_order.push("g");
music_order.push("6");
music_order.push("a");
music_order.push("7");

for(var i=0;i<84;i++)
{
	chord.push(false);
}

for(var i=0;i<music_order.length;i++)
{
	music_file_name.push(music_order[i]+"bbb");
}

for(var i=0;i<music_order.length;i++)
{
	music_file_name.push(music_order[i]+"bb");
}

for(var i=0;i<music_order.length;i++)
{
	music_file_name.push(music_order[i]+"b");
}

for(var i=0;i<music_order.length;i++)
{
	music_file_name.push(music_order[i]);
}

for(var i=0;i<music_order.length;i++)
{
	music_file_name.push(music_order[i]+"s");
}

for(var i=0;i<music_order.length;i++)
{
	music_file_name.push(music_order[i]+"ss");
}

for(var i=0;i<music_order.length;i++)
{
	music_file_name.push(music_order[i]+"sss");
}

for(var i=0;i<music_file_name.length;i++)
{
	audio_element[i] = new Audio(music_file_name[i]+".wav");
	audio_element[i].id=music_file_name[i];
	document.documentElement.appendChild(audio_element[i]);
}

function suddenly(){
	if(str[index-2] != "0")
	{
		if(str[index-2][0] == '-')
		{
			for(var i=0;i<temp_chord.length;i++)
			{
				document.getElementById(temp_chord[i]).pause();
				document.getElementById(temp_chord[i]).currentTime=0;
			}
		}
		else
		{
			document.getElementById(str[index-2]).pause();
			document.getElementById(str[index-2]).currentTime=0;
		}
	}
	
	play_music();
}

function cont(){
	if(str[index] && str[index]!="0")
	{
		if(str[index][0]!="-")
		{
			document.getElementById(str[index]).play();
		}
		else
		{
			for(var i=0;i<temp_chord.length;i++)
			{
				document.getElementById(temp_chord[i]).play();
			}
		}
	}
}

p.addEventListener("click",parse_sheet);
r.addEventListener("click",random_sheet);
dis.addEventListener("click",display_sheet);

function parse_sheet(){
  if(sheet_music.value)
  {
	str = sheet_music.value.split(" ");
	str =str.filter(function(e){return e});
  }
  play_music();
}

function random_sheet(){
  if( isNaN(parseFloat(note_number.value)) || isFinite(note_number.value))
  {
	note_number.value=5;
  }
  
  str=[];
  
  for(var i=0;i<note_number.value;i++)
  {
	str.push(music_file_name[Math.floor(Math.random() * music_file_name.length)]);
	str.push(time_value[Math.floor(Math.random() * time_value.length)]);
  }
  
  play_music();
}

function display_sheet(){
 for(var i=0;i<str.length;i++)
 {
	sheet_music.value += " ";
	sheet_music.value += str[i];
 }
}

function play_music(){
 if(str[index])
 {
	if(str[index] != 0)
	{
		if(str[index][0] != '-')
		{
			document.getElementById(str[index++]).play();
		}
		else
		{
		 temp_chord =str[index++].split('-');
		 
		 for(var i=0;i<chord.length;i++)
		 {
			chord[i]=false;
		 }
		 
		 temp_chord =temp_chord.filter(function(e){return e});
		 for(var i=0;i<temp_chord.length;i++)
		 {
			document.getElementById(temp_chord[i]).play();
			chord[music_file_name.indexOf(temp_chord[i])]=true;
		 }
		 
		}
	}
	else
	{
		index++;
	}
	setTimeout(suddenly,str[index]);
	setTimeout(cont,str[index++]-100);
 }
 else
 {
	index=0;
 }
}

/*document.onkeydown=function(e){
  console.log(e.keyCode);

  if (keyAllowed [e.which] === false) return;
  keyAllowed [e.which] = false;

  switch(e.keyCode)
  {
    case 65:
      music_C.play();
      break;
    case 83:
      music_D.play();
      break;
    case 68:
      music_E.play();
      break;
    case 70:
      music_F.play();
      break;
    case 71:
      music_G.play();
      break;
    case 72:
      music_A.play();
      break;
    case 74:
      music_B.play();
      break;
    case 75:
      music_C_sharp.play();
      break;
    case 76:
      music_D_sharp.play();
      break;
    case 59:
    case 186:
      music_E_sharp.play();
      break;
    case 222:
      music_F_sharp.play();
      break;
    case 90:
      music_G_sharp.play();
      break;
    case 88:
      music_A_sharp.play();
      break;
    case 67:
      music_B_sharp.play();
      break;
  }
}

document.onkeyup=function(e){

  keyAllowed [e.which] = true;

  switch(e.keyCode)
  {
    case 65:
      music_C.pause();
      music_C.currentTime=0;
      break;
    case 83:
      music_D.pause();
      break;
    case 68:
      music_E.pause();
      break;
    case 70:
      music_F.pause();
      break;
    case 71:
      music_G.pause();
      break;
    case 72:
      music_A.pause();
      break;
    case 74:
      music_B.pause();
      break;
    case 75:
      music_C_sharp.pause();
      break;
    case 76:
      music_D_sharp.pause();
      break;
    case 59:
    case 186:
      music_E_sharp.pause();
      break;
    case 222:
      music_F_sharp.pause();
      break;
    case 90:
      music_G_sharp.pause();
      break;
    case 88:
      music_A_sharp.pause();
      break;
    case 67:
      music_B_sharp.pause();
      break;
  }
}*/

var temp;
var xhr=[];
var dv=[];
var target_dv;
var f;

$(document).ready(function (){

for(var i=0;i<music_file_name.length;i++)
{
xhr[i] = new XMLHttpRequest();
xhr[i].open('GET', music_file_name[i]+".wav", true);
xhr[i].responseType = 'arraybuffer';
 
xhr[i].onload = function(e) {
  // response is unsigned 8 bit integer
  temp = new Uint8Array(this.response); 
  
  var file = new File([temp], music_file_name[i]+".wav", {
  type: "audio/wav",
});

var reader = new FileReader();

reader.readAsArrayBuffer(file);
reader.onload = function (data) {
		dv.push(new DataView(data.target.result,0,data.target.result.byteLength));
		if(dv.length==84)
		{
			load_success();
		}
    }
}

xhr[i].send();
}});


function load_success(){
	var buffer = new ArrayBuffer(dv[70].byteLength);
	target_dv = new DataView(buffer);
	console.log(buffer.byteLength);
	for(var i=0;i<buffer.byteLength;i++)
	{
		target_dv.setInt8(i,dv[70].getInt8(i));
	}
	f = new Blob([target_dv],{type: 'audio/wav'});
}

save_file.addEventListener("click",download);

function download() {
	var download_link = document.createElement('a');
	var url = window.URL.createObjectURL(f);
	download_link.href= url;
    download_link.setAttribute('download', "t.wav");
	
    if (document.createEvent) {
        var event = document.createEvent('MouseEvents');
        event.initEvent('click', true, true);
        download_link.dispatchEvent(event);
    }
    else {
        download_link.click();
    }
}

</script>

<body>
</body>
</html>
