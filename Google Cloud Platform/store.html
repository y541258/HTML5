<!DOCTYPE html>
<meta charset="utf-8"> 
<html>
<body>

<script src="jquery-3.3.1.js"></script>

<canvas id="myCanvas" width="640" height="480"></canvas>

<script>
var items_name=[];
var items_price=[];

var now_store_item=[];

var ws;
    $(function(){
        link();
    })
    function link () {
	    ws = new WebSocket('ws://' + window.location.host + '/ws');
        //ws = new WebSocket("ws://127.0.0.1:8000/ws");//连接服务器
		ws.binaryType = 'arraybuffer';
        ws.onopen = function(event){
            console.log(event);
            alert('連接');
        };
		
        ws.onmessage = function (event) {
		
		var dv = new DataView(event.data);
		var textDecoder = new TextDecoder('utf-8');
		str = textDecoder.decode(dv);
		
		now_store_item = str.split(',');

		re_draw();
        
        ws.onclose = function(event){alert("與伺服器連線中斷");};
        ws.onerror = function(event){alert("WebSocket Error");};
    }
}

var c=document.getElementById("myCanvas");
var ctx=c.getContext("2d");

ctx.fillStyle="#FFFFFF";


 $.getJSON("store_item.json",function(){
 console.log("success");
 })
 .done(function(data) {
  $.each( data, function( key, val ) {
		for(var i=0;i<data.store_item.length;i++)
		{
			items_name.push(val[i].name);
			items_price.push(val[i].price);
		}
	})
 })
 
 .fail(function(jqXHR, textStatus, errorThrown) { alert('getJSON request failed! ' + textStatus); }) 
 
function re_draw()
{
	ctx.fillStyle="#FFFFFF"; 

	ctx.fillRect(0,0,c.width,c.height);

	ctx.fillStyle="#000000";
	ctx.font="40px 標楷體";

	for(var i=0;i<5;i++)
	{
		ctx.fillText(items_name[now_store_item[i]] ,30+i*120,50);
		ctx.fillText(items_price[now_store_item[i]] ,30+i*120,100);
	}
	
}

function shuffle(array) {
  var m = array.length, t, i;
  while (m) {
    i = Math.floor(Math.random() * m--);
    t = array[m];
    array[m] = array[i];
    array[i] = t;
  }
}

function click_region(id,left,top,width,height)
{
	this.id=id;

	var self=this;

	this.left=left;
	this.top=top;
	this.width=width;
	this.height=height;
	
	$(c).on('handleClick', function(e, mouse) {
        if (self.left < mouse.x && 
            self.left + self.width > mouse.x && 
            self.top < mouse.y && 
            self.top + self.height > mouse.y) {

        } 
    });
}

var elements=[];

//elements.push(new click_region(i,i%4*c.width/4,parseInt(i/4)*c.height/4,c.width/4,c.height/4));

	
$(c).on('click', function(e) { 
	var mouse= { 
        x: e.pageX - c.offsetLeft, 
        y: e.pageY - c.offsetTop
	} 
         
    //fire off synthetic event containing mouse coordinate info 
    $(c).trigger('handleClick', [mouse]);
 });

</script>

</body>
</html>
