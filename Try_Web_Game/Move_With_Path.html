<!DOCTYPE html>
<meta charset="utf-8"> 
<html>
<body>

<script src="jquery-3.3.1.js"></script>

<canvas id="myCanvas" width="640" height="480"></canvas>

<script>
var path =[];
var graphic_center_offset=64/2;
var character_left=50;
var character_top=50;
var character_coordinate=[character_left+graphic_center_offset,character_top+graphic_center_offset];
//character圖檔大小是64*64
//但drawImage是從指定點為圖片的左上角開始畫
//所以要這樣取得中心點
var timer_id;
/*
var items_name=[];
var items_price=[];

var which_message=[];
var buy_item=[]
var now_store_item=[];
var user_order=["user","","","","",""];

var ws;
    $(function(){
        link();
    })
    function link () {
	    //ws = new WebSocket('ws://' + window.location.host + '/ws');
        ws = new WebSocket("ws://127.0.0.1:8080/ws");//连接服务器
		ws.binaryType = 'arraybuffer';
        ws.onopen = function(event){
            alert('連接');
        };
		
        ws.onmessage = function (event) {
		
		var dv = new DataView(event.data);
		var textDecoder = new TextDecoder('utf-8');
		str = textDecoder.decode(dv);
		
		which_message = str.split(',')
		
		switch (which_message[0])
		{
			case "store":
				buy_item = [];
				user_order=["user","","","","",""];
				now_store_item = which_message;
				break;
			case "buy":
				buy_item = which_message;
				break;
			case "user":
				user_order = which_message;
				break;
				
		}
		
		console.log(which_message);

		re_draw();
        
        ws.onclose = function(event){alert("與伺服器連線中斷");};
        ws.onerror = function(event){alert("WebSocket Error");};
    }
}
*/
var c=document.getElementById("myCanvas");
var ctx=c.getContext("2d");

ctx.fillStyle="#FFFFFF";


 /*$.getJSON("store_item.json",function(){
 console.log("success");
 })
 .done(function(data) {
  $.each( data, function( key, val ) {
		for(var i=0;i<data.store_item.length;i++)
		{
			items_name.push(val[i].name);
			items_price.push(val[i].price);
		}
	})
 })
 
 .fail(function(jqXHR, textStatus, errorThrown) { alert('getJSON request failed! ' + textStatus); }) 
 */
 
 var img= new Image();
img.src="character.png";

img.onload =function(){
	re_draw();
}
 
function Point(x,y)
{
	this.x=x;
	this.y=y;
}
	
$(c).on('handleClick', function(e, mouse) {
		path.push(new Point(mouse.x,mouse.y));
		
		if(path.length==1)
		{
			timer_id =setInterval(move_with_line,10);
			//setInterval(move_with_arc,500);
		}
		else if(path.length>1)
		{
		 clearInterval(timer_id);
		 path = path.slice(1,2);
		 timer_id =setInterval(move_with_line,10);
		 console.dir(path);
		}
});

function move_with_line(){
	if(character_coordinate[0] == path[0].x &&
	   character_coordinate[1] == path[0].y)
	{
		alert("移動完成");
		clearInterval(timer_id);
		path =[];
		return;
	}
	
	if(character_coordinate[0] != path[0].x)
	{
		if(path[0].x > character_coordinate[0])
		{
			character_left++;
			character_coordinate[0]=character_left+graphic_center_offset;
		}
		else
		{
			character_left--;
			character_coordinate[0]=character_left+graphic_center_offset;
		}
		
		//這麼寫能成立是建立在整數座標的狀況下
		//若是浮點(小數或說分數)座標還得另外處理
		re_draw();
	}
	
	if(character_coordinate[1] != path[0].y)
	{
		if(path[0].y > character_coordinate[1])
		{
			character_top++;
			character_coordinate[1]=character_top+graphic_center_offset;
		}
		else
		{
			character_top--;
			character_coordinate[1]=character_top+graphic_center_offset;
		}
		
		//這麼寫能成立是建立在整數座標的狀況下
		//若是浮點(小數或說分數)座標還得另外處理
		re_draw();
	}
}

function move_with_arc(){
	
}
 
function re_draw()
{
	ctx.fillStyle="#FFFFFF"; 
	ctx.fillRect(0,0,c.width,c.height);

	ctx.drawImage(img,0,0,64,64,character_left,character_top,64,64);
}

function shuffle(array) {
  var m = array.length, t, i;
  while (m) {
    i = Math.floor(Math.random() * m--);
    t = array[m];
    array[m] = array[i];
    array[i] = t;
  }
}

function click_region(id,left,top,width,height)
{
	this.id=id;

	var self=this;

	this.left=left;
	this.top=top;
	this.width=width;
	this.height=height;
	
	$(c).on('handleClick', function(e, mouse) {
        if (self.left < mouse.x && 
            self.left + self.width > mouse.x && 
            self.top < mouse.y && 
            self.top + self.height > mouse.y) {
			/*
			alert(now_store_item[self.id+1] + " " + items_name[now_store_item[self.id+1]])
			ws.send("buy," + parseInt(parseInt(now_store_item[self.id+1])+1) + "," + self.id);
			//now_store_item[self.id+1]+1 因為編號是從1開始,所以再+1
			*/
        } 
    });
}

var elements=[];

for(var i=0;i<5;i++)
{
	elements.push(new click_region(i,30+i*120,50,120,90));
}

	
$(c).on('click', function(e) { 
	var mouse= { 
        x: e.pageX - c.offsetLeft, 
        y: e.pageY - c.offsetTop
	} 
         
    //fire off synthetic event containing mouse coordinate info 
    $(c).trigger('handleClick', [mouse]);
 });

</script>

</body>
</html>
