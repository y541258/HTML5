<!DOCTYPE html>
<meta charset="utf-8"> 
<html>
<body>

<script src="jquery-3.3.1.js"></script>

<canvas id="myCanvas" width="640" height="480"></canvas>
<div id="div_test"></div>

<script>
var path =[];
var graphic_center_offset=64/2;
var character_left=50;
var character_top=50;
var character_coordinate=[character_left+graphic_center_offset,character_top+graphic_center_offset];

/*
var result=[];
var cp =[];
cp.push(new Point(50+graphic_center_offset,50+graphic_center_offset));
cp.push(new Point(70+graphic_center_offset,70+graphic_center_offset));
cp.push(new Point(50+graphic_center_offset,70+graphic_center_offset));
cp.push(new Point(110+graphic_center_offset,50+graphic_center_offset));
*/

var path_record=[];
var record_flag=false;

var run_t=0;

//character圖檔大小是64*64
//但drawImage是從指定點為圖片的左上角開始畫
//所以要這樣取得中心點
var timer_id;
/*
var items_name=[];
var items_price=[];

var which_message=[];
var buy_item=[]
var now_store_item=[];
var user_order=["user","","","","",""];

var ws;
    $(function(){
        link();
    })
    function link () {
	    //ws = new WebSocket('ws://' + window.location.host + '/ws');
        ws = new WebSocket("ws://127.0.0.1:8080/ws");//连接服务器
		ws.binaryType = 'arraybuffer';
        ws.onopen = function(event){
            alert('連接');
        };
		
        ws.onmessage = function (event) {
		
		var dv = new DataView(event.data);
		var textDecoder = new TextDecoder('utf-8');
		str = textDecoder.decode(dv);
		
		which_message = str.split(',')
		
		switch (which_message[0])
		{
			case "store":
				buy_item = [];
				user_order=["user","","","","",""];
				now_store_item = which_message;
				break;
			case "buy":
				buy_item = which_message;
				break;
			case "user":
				user_order = which_message;
				break;
				
		}
		
		console.log(which_message);

		re_draw();
        
        ws.onclose = function(event){alert("與伺服器連線中斷");};
        ws.onerror = function(event){alert("WebSocket Error");};
    }
}
*/
var c=document.getElementById("myCanvas");
var ctx=c.getContext("2d");

ctx.fillStyle="#FFFFFF";


 /*$.getJSON("store_item.json",function(){
 console.log("success");
 })
 .done(function(data) {
  $.each( data, function( key, val ) {
		for(var i=0;i<data.store_item.length;i++)
		{
			items_name.push(val[i].name);
			items_price.push(val[i].price);
		}
	})
 })
 
 .fail(function(jqXHR, textStatus, errorThrown) { alert('getJSON request failed! ' + textStatus); }) 
 */
 
 var img= new Image();
img.src="character.png";

img.onload =function(){
	re_draw();
}
 
function Point(x,y)
{
	this.x=x;
	this.y=y;
}

//set_path();
//console.dir(result);

$(c).on('handleClick', function(e, mouse) {
		/*path.push(new Point(mouse.x,mouse.y));
		
		console.dir(path);
		
		if(path.length==1)
		{
			//timer_id =setInterval(move_with_line,10);
			timer_id =setInterval(move_with_arc,10);
			//setInterval(move_with_arc,500);
		}
		else if(path.length>1)
		{
		 clearInterval(timer_id);
		 path = path.slice(1,2);
		 //timer_id =setInterval(move_with_line,10);
		 timer_id =setInterval(move_with_arc,10);
		}*/
});

/*
function move_with_line(){
	if(character_coordinate[0] == path[0].x &&
	   character_coordinate[1] == path[0].y)
	{
		alert("移動完成");
		clearInterval(timer_id);
		path =[];
		return;
	}
	
	if(character_coordinate[0] != path[0].x)
	{
		if(path[0].x > character_coordinate[0])
		{
			character_left++;
			character_coordinate[0]=character_left+graphic_center_offset;
		}
		else
		{
			character_left--;
			character_coordinate[0]=character_left+graphic_center_offset;
		}
		
		//這麼寫能成立是建立在整數座標的狀況下
		//若是浮點(小數或說分數)座標還得另外處理
		re_draw();
	}
	
	if(character_coordinate[1] != path[0].y)
	{
		if(path[0].y > character_coordinate[1])
		{
			character_top++;
			character_coordinate[1]=character_top+graphic_center_offset;
		}
		else
		{
			character_top--;
			character_coordinate[1]=character_top+graphic_center_offset;
		}
		
		//這麼寫能成立是建立在整數座標的狀況下
		//若是浮點(小數或說分數)座標還得另外處理
		re_draw();
	}
}*/

function move_with_really_line(){
	//直線方程式 y=mx m是斜率,m代表垂直間距除以水平間距
	//因此兩點式是 y-y₀ = (y₁-y₀ * x-x₀) / (x₁-x₀)
	
	//測試指定座標用
	//path[0].x = 50+graphic_center_offset;
	//path[0].y = 70+graphic_center_offset;
	
	if(parseInt(character_coordinate[0]) == path[0].x &&
	   parseInt(character_coordinate[1]) == path[0].y)
	{
		alert("移動完成");
		clearInterval(timer_id);
		path =[];
		return;
	} 
	
	//就算求出斜率,理論上還要考慮角色的行走速度
	//目前這樣寫是瞬間移動
	//先確認能瞬間移動
	
	/*
	character_coordinate[0] = path[0].x;
	character_left = character_coordinate[0] - graphic_center_offset;
	
	character_coordinate[1] = path[0].y;
	character_top = character_coordinate[1] - graphic_center_offset;
	*/
	
	//若要考慮行走速度(步輻),我這程式步幅是1
	//不轉整數很可能走不到目的地,因為走的是取到小數下13位
	//但點擊的座標本身是整數
	
	if(parseInt(character_coordinate[0]) != path[0].x)
	{
		character_left += Math.cos(Math.atan2(path[0].y-character_coordinate[1],path[0].x-character_coordinate[0]));
		character_coordinate[0] = character_left + graphic_center_offset;
		console.log(parseInt(character_coordinate[0]));
	}
	
	if(parseInt(character_coordinate[1]) != path[0].y)
	{
		character_top += Math.sin(Math.atan2(path[0].y-character_coordinate[1],path[0].x-character_coordinate[0]));
		character_coordinate[1] = character_top + graphic_center_offset;
		console.log("character_top"+character_top);
		console.log(parseInt(character_coordinate[1]));
	}
}

function move_with_arc(){
/*
	//這段是二次方
	path[0].x = 70+graphic_center_offset;
	path[0].y = 50+graphic_center_offset;

	if(parseInt(character_coordinate[0]) == path[0].x &&
	   parseInt(character_coordinate[1]) == path[0].y)
	{
		alert("移動完成");
		clearInterval(timer_id);
		path =[];
		return;
	}
	
	if(parseInt(character_coordinate[0]) != path[0].x)
	{
		character_left += 1;
		character_coordinate[0] = character_left + graphic_center_offset;
	}
	
	character_top = (character_left-60)*(character_left-60)/10 + 40
	character_coordinate[1] = character_top + graphic_center_offset;	
	*/

	//這段是三次貝茲曲線
	/*
	path[0].x = 110+graphic_center_offset;
	path[0].y = 50+graphic_center_offset;

	character_left += Math.cos(Math.atan2(result[run_t].y-character_coordinate[1],result[run_t].x-character_coordinate[0]));
	character_coordinate[0] = character_left + graphic_center_offset;

	character_top += Math.sin(Math.atan2(result[run_t].y-character_coordinate[1],result[run_t].x-character_coordinate[0]));
	character_coordinate[1] = character_top + graphic_center_offset;
	
	run_t++;
	
	if(run_t==result.length)
	{
		alert("移動完成");
		clearInterval(timer_id);
		console.log(character_left);
		console.log(character_top);
		path =[];
		return;
	} */
	
	//讓圖片照畫的路徑移動,但是實測結果會跳過些pixel
	
	character_left = path_record[run_t+1].x-graphic_center_offset;
	character_top = path_record[run_t+1].y-graphic_center_offset;
	
	run_t++;
	
	if(run_t == path_record.length-1)
	{
		path_record=[];
		clearInterval(timer_id);
		run_t=0;
		console.log(character_coordinate[0]);
		console.log(character_left);
		console.log(character_coordinate[1]);
	}
}

function set_path()
{
	var dt = 1.0 / ( 300 - 1 );

    for(var i = 0; i < 300; i++)
	{
        cubic_Bezier(i*dt);
	}
}

function cubic_Bezier(t)
{
	var ax,bx,cx,ay,by,cy;
	
	cx = 3.0 * (cp[1].x - cp[0].x);
    bx = 3.0 * (cp[2].x - cp[1].x) - cx;
    ax = cp[3].x - cp[0].x - cx - bx;

    cy = 3.0 * (cp[1].y - cp[0].y);
    by = 3.0 * (cp[2].y - cp[1].y) - cy;
    ay = cp[3].y - cp[0].y - cy - by;

    tSquared = t * t;
    tCubed = tSquared * t;

	result.push(new Point((ax * tCubed) + (bx * tSquared) + (cx * t) + cp[0].x,(ay * tCubed) + (by * tSquared) + (cy * t) + cp[0].y));
}
 
function re_draw()
{
	ctx.fillStyle="#FFFFFF"; 
	ctx.fillRect(0,0,c.width,c.height);

	ctx.drawImage(img,0,0,64,64,character_left,character_top,64,64);
	
	requestAnimationFrame(re_draw);
}

function shuffle(array) {
  var m = array.length, t, i;
  while (m) {
    i = Math.floor(Math.random() * m--);
    t = array[m];
    array[m] = array[i];
    array[i] = t;
  }
}

function click_region(id,left,top,width,height)
{
	this.id=id;

	var self=this;

	this.left=left;
	this.top=top;
	this.width=width;
	this.height=height;
	
	$(c).on('handleClick', function(e, mouse) {
        if (self.left < mouse.x && 
            self.left + self.width > mouse.x && 
            self.top < mouse.y && 
            self.top + self.height > mouse.y) {
			/*
			alert(now_store_item[self.id+1] + " " + items_name[now_store_item[self.id+1]])
			ws.send("buy," + parseInt(parseInt(now_store_item[self.id+1])+1) + "," + self.id);
			//now_store_item[self.id+1]+1 因為編號是從1開始,所以再+1
			*/
        } 
    });
}

var elements=[];

for(var i=0;i<5;i++)
{
	elements.push(new click_region(i,30+i*120,50,120,90));
}

	
$(c).on('click', function(e) {
	var mouse= { 
        x: e.pageX - c.offsetLeft, 
        y: e.pageY - c.offsetTop
	} 
         
    //fire off synthetic event containing mouse coordinate info 
    $(c).trigger('handleClick', [mouse]);
 });
 
$(c).on('mousedown', function(e) {
	record_flag=true;
	console.dir(path_record);
	path_record=[];
}); 
 
$(c).on('mouseup', function(e) {
	record_flag=false;
	character_left=path_record[0].x-graphic_center_offset;
	character_top=path_record[0].y-graphic_center_offset;
	timer_id =setInterval(move_with_arc,10);
	console.dir(path_record);
});

$(c).on('mousemove', function(e) {
	if(record_flag)
	{
		path_record.push(new Point(e.pageX - c.offsetLeft,e.pageY - c.offsetTop));
		document.getElementById("div_test").innerHTML += (e.pageX - c.offsetLeft).toString() + "," + (e.pageY - c.offsetTop).toString() + "<br>";
		//記錄下來,以後可以複製結果存到個檔案來讀取使用
	}
});

</script>

</body>
</html>
